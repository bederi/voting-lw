<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Anonymous Voting App with Dashboard</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f2f2f2; }
    h2 { color: #333; }
    label { display: block; margin: 4px 0; }
    .section { margin-top: 30px; background: #fff; padding: 15px; border-radius: 5px; }
    button { margin: 20px 0; padding: 10px 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 30px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #eee; }
    #dashboard { margin-top: 50px; background: #fff; padding: 15px; border-radius: 5px; }
    .chart-container { width: 100%; max-width: 400px; display: inline-block; vertical-align: top; margin-right: 20px; }
    @media (max-width: 900px) {
      .chart-container { display: block; margin: 0 auto 30px auto; }
    }
  </style>
</head>
<body>

  <h2>Select Your Name</h2>
  <select id="voterSelect">
    <option value="">-- Choose your name --</option>
    <option>Bederi</option>
    <option>Sil</option>
    <option>Saeed</option>
    <option>Gintoki</option>
    <option>Carnele</option>
    <option>Blaze</option>
    <option>Lyo</option>
    <option>Nigma</option>
    <option>w3d</option>
    <option>Lux</option>
    <option>Rosi</option>
  </select>

  <div id="voteSections" style="display:none">

    <div class="section">
      <h2>Alliance Leader (Choose 1)</h2>
      <select id="step1"></select>
    </div>

    <div class="section">
      <h2>Tactician Rewards (Choose up to 4)</h2>
      <div id="checkboxStep2"></div>
    </div>

    <div class="section">
      <h2>Core Member Rewards (Choose up to 9 from Candidate List)</h2>
      <div id="checkboxStep3"></div>
    </div>

    <div class="section">
      <h2>Elite Rewards (Choose up to 30 from Candidate List)</h2>
      <div id="checkboxStep4"></div>
    </div>

    <button onclick="submitVotes()">Submit Vote</button>
  </div>

  <table id="resultsTable">
    <thead>
      <tr>
        <th>Alliance Leader</th>
        <th>Tactician Rewards (4)</th>
        <th>Core Member Rewards (9)</th>
        <th>Elite Rewards (30)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="dashboard" style="display:none">
    <h2>Dashboard: Voting Results</h2>
    <div class="chart-container">
      <h3>Alliance Leader</h3>
      <canvas id="chart1"></canvas>
    </div>
    <div class="chart-container">
      <h3>Tactician Rewards</h3>
      <canvas id="chart2"></canvas>
    </div>
    <div class="chart-container">
      <h3>Core Member Rewards</h3>
      <canvas id="chart3"></canvas>
    </div>
    <div class="chart-container">
      <h3>Elite Rewards</h3>
      <canvas id="chart4"></canvas>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const allNames = ['Bederi','Sil','Saeed','Gintoki','Carnele','Blaze','Lyo','Nigma','w3d','Lux','Rosi'];
    const largeList = [
      "General S","KKM","Puffo","Pino","West","JT","BBC","Don","Luis","Damian","Phini","Neo Noir",
      "Jojo","Draco","Milan","Hutaz","Ershy","Ninja","Gianluca","Gandalf","Vergil","Borghez","Shark",
      "Quack","Itachi","Dennis","Panda","Tudor","Maverick","Mango","Hercules Saeed","Akechi","Steku",
      "jox","Kaschi","alex1m","hartman","linoleum","king of q","Rob","markov","Tano","Chicken Saeed",
      "Ibra","Old slow man","milo","johnny","krokolin","puhlya","mars","cardillo","misanthrop","kikka",
      "007","ludo","mzrab","raffa","hellfire","Mai","hpyroz","kuscheldrache","tempesta","adreasromy",
      "pepe","sirdrago","spirit","pavel","dondonderon","momax","kobee","berli","dark lady","fabibi",
      "devily","girami","Vi","Ivan","Mik","regulus","Lasion","NataliaPhilo","norichiko","MRC","DrJoker"
    ];
    const submittedVotes = [];
    let voterName = "";

    document.getElementById('voterSelect').addEventListener('change', function () {
      voterName = this.value;
      if (!voterName) return;
      document.getElementById('voteSections').style.display = 'block';
      renderAllCategories();
      setupSmartFiltering();
    });

    function renderAllCategories() {
      // Step 1: Alliance Leader (can't pick yourself)
      loadDropdown('step1', allNames.filter(name => name !== voterName));
      // Step 2: Tactician (can't pick yourself)
      loadCheckboxesWithLimit('checkboxStep2', allNames.filter(name => name !== voterName), 4);
      // Step 3: Core Members (large list, can't pick yourself if in list)
      loadCheckboxesWithLimit('checkboxStep3', largeList.filter(name => name !== voterName), 9);
      // Step 4: Elite Rewards (large list, can't pick yourself)
      loadCheckboxesWithLimit('checkboxStep4', largeList.filter(name => name !== voterName), 30);
    }

    function loadDropdown(id, options) {
      const select = document.getElementById(id);
      select.innerHTML = '';
      options.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt;
        o.text = opt;
        select.appendChild(o);
      });
    }

    function loadCheckboxesWithLimit(containerId, options, limit) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      options.forEach(opt => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = opt;
        checkbox.addEventListener('change', () => {
          const checked = container.querySelectorAll('input:checked');
          if (checked.length >= limit) {
            container.querySelectorAll('input:not(:checked)').forEach(cb => cb.disabled = true);
          } else {
            container.querySelectorAll('input').forEach(cb => cb.disabled = false);
          }
          applySmartFiltering();
        });
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(' ' + opt));
        container.appendChild(label);
      });
    }

    function getChecked(containerId) {
      return Array.from(document.getElementById(containerId).querySelectorAll('input:checked')).map(c => c.value);
    }

    // Smart Filtering between all categories
    function setupSmartFiltering() {
      document.getElementById('step1').addEventListener('change', applySmartFiltering);
      Array.from(document.getElementById('checkboxStep2').querySelectorAll('input')).forEach(cb => {
        cb.addEventListener('change', applySmartFiltering);
      });
      Array.from(document.getElementById('checkboxStep3').querySelectorAll('input')).forEach(cb => {
        cb.addEventListener('change', applySmartFiltering);
      });
      Array.from(document.getElementById('checkboxStep4').querySelectorAll('input')).forEach(cb => {
        cb.addEventListener('change', applySmartFiltering);
      });
    }

    function applySmartFiltering() {
      // Gather all selected names from each step
      const selectedStep1 = document.getElementById('step1').value;
      const selectedStep2 = getChecked('checkboxStep2');
      const selectedStep3 = getChecked('checkboxStep3');
      const selectedStep4 = getChecked('checkboxStep4');

      const pickedNames = [];
      if (selectedStep1) pickedNames.push(selectedStep1);
      pickedNames.push(...selectedStep2, ...selectedStep3, ...selectedStep4);

      // Step 1 dropdown: disable options picked elsewhere
      const selectStep1 = document.getElementById('step1');
      Array.from(selectStep1.options).forEach(opt => {
        opt.disabled = pickedNames.includes(opt.value) && opt.value !== selectedStep1;
      });
      if (selectStep1.options[selectStep1.selectedIndex] && selectStep1.options[selectStep1.selectedIndex].disabled) {
        selectStep1.value = '';
      }

      // Step 2 checkboxes
      Array.from(document.getElementById('checkboxStep2').querySelectorAll('input')).forEach(cb => {
        if (pickedNames.includes(cb.value) && !selectedStep2.includes(cb.value)) {
          cb.checked = false;
          cb.disabled = true;
        } else {
          cb.disabled = false;
        }
      });

      // Step 3 checkboxes
      Array.from(document.getElementById('checkboxStep3').querySelectorAll('input')).forEach(cb => {
        if (pickedNames.includes(cb.value) && !selectedStep3.includes(cb.value)) {
          cb.checked = false;
          cb.disabled = true;
        } else {
          cb.disabled = false;
        }
      });

      // Step 4 checkboxes
      Array.from(document.getElementById('checkboxStep4').querySelectorAll('input')).forEach(cb => {
        if (pickedNames.includes(cb.value) && !selectedStep4.includes(cb.value)) {
          cb.checked = false;
          cb.disabled = true;
        } else {
          cb.disabled = false;
        }
      });
    }

    function submitVotes() {
      const s1 = document.getElementById('step1').value;
      const s2 = getChecked('checkboxStep2');
      const s3 = getChecked('checkboxStep3');
      const s4 = getChecked('checkboxStep4');

      if (!s1 || s2.length !== 4 || s3.length !== 9 || s4.length !== 30) {
        alert("Make sure you've selected exactly: 1 Alliance Leader, 4 Tactician Rewards, 9 Core Member Rewards, 30 Elite Rewards.");
        return;
      }

      const vote = { step1: s1, step2: s2, step3: s3, step4: s4 };
      submittedVotes.push(vote);
      updateTable();
      updateDashboard();
      alert("âœ… Vote submitted!");
      resetVoting();
    }

    function updateTable() {
      const tbody = document.querySelector('#resultsTable tbody');
      tbody.innerHTML = '';
      submittedVotes.forEach(vote => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${vote.step1}</td>
          <td>${vote.step2.join(', ')}</td>
          <td>${vote.step3.join(', ')}</td>
          <td>${vote.step4.join(', ')}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Chart.js Pie Charts
    let chart1, chart2, chart3, chart4;

    function updateDashboard() {
      document.getElementById('dashboard').style.display = 'block';

      // Count votes per name for each category
      const countVotes = (key, limitList) => {
        const counter = {};
        submittedVotes.forEach(vote => {
          let items = Array.isArray(vote[key]) ? vote[key] : [vote[key]];
          items.forEach(name => {
            if (!limitList || limitList.includes(name)) {
              counter[name] = (counter[name] || 0) + 1;
            }
          });
        });
        return counter;
      };

      // Pie for Alliance Leader
      const data1 = countVotes('step1', allNames);
      renderPieChart('chart1', data1, allNames);

      // Pie for Tactician Rewards
      const data2 = countVotes('step2', allNames);
      renderPieChart('chart2', data2, allNames);

      // Pie for Core Member Rewards
      const data3 = countVotes('step3', largeList);
      renderPieChart('chart3', data3, largeList);

      // Pie for Elite Rewards
      const data4 = countVotes('step4', largeList);
      renderPieChart('chart4', data4, largeList);
    }

    function renderPieChart(canvasId, data, labelsList) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      const labels = Object.keys(data);
      const values = Object.values(data);

      // Only show names with at least 1 vote for clarity
      const filteredLabels = labels.filter((l, i) => values[i] > 0);
      const filteredData = values.filter(v => v > 0);

      // Random pastel colors
      const colors = filteredLabels.map((_, i) => `hsl(${i * 37 % 360}, 70%, 70%)`);

      // Destroy previous chart if exists
      if (canvasId === 'chart1' && chart1) chart1.destroy();
      if (canvasId === 'chart2' && chart2) chart2.destroy();
      if (canvasId === 'chart3' && chart3) chart3.destroy();
      if (canvasId === 'chart4' && chart4) chart4.destroy();

      const chart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: filteredLabels,
          datasets: [{
            data: filteredData,
            backgroundColor: colors,
            borderWidth: 1
          }]
        },
        options: {
          plugins: {
            legend: { display: true, position: 'bottom' }
          }
        }
      });

      if (canvasId === 'chart1') chart1 = chart;
      if (canvasId === 'chart2') chart2 = chart;
      if (canvasId === 'chart3') chart3 = chart;
      if (canvasId === 'chart4') chart4 = chart;
    }

    function resetVoting() {
      document.getElementById('voterSelect').value = '';
      document.getElementById('voteSections').style.display = 'none';
    }
  </script>

</body>
</html>
